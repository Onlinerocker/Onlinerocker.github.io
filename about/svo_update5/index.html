<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 2.25.3"/><link as="script" rel="preload" href="/webpack-runtime-8318ef4a64b565e59cda.js"/><link as="script" rel="preload" href="/framework-aad5b025b9e173e1e8c7.js"/><link as="script" rel="preload" href="/app-d49afff437e1dfef4477.js"/><link as="script" rel="preload" href="/commons-a30d9b8c89d158d4c38c.js"/><link as="script" rel="preload" href="/component---src-pages-svo-update-5-js-fcc98e07cae929786ffb.js"/><link as="fetch" rel="preload" href="/page-data\svo_update5\page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data\app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous"/><nav class="navbar navbar-expand navbar-dark bg-dark"><span class="navbar-brand"><img src="/leaf.png" width="42" height="30" class="d-inline-block align-top" alt=""/></span><span class="navbar-brand">Gabe Caldwell</span><div class="mr-auto navbar-nav"><div class="nav-item"><a href="/" data-rb-event-key="/" class="nav-link">Projects</a></div><div class="nav-item"><a href="/resume" data-rb-event-key="/resume" class="nav-link">Resume</a></div><div class="nav-item"><a href="/blog" data-rb-event-key="/blog" class="nav-link">Blog</a></div><div class="nav-item"><a href="/about" data-rb-event-key="/about" class="nav-link">About</a></div></div></nav><div class="container-fluid"><br/><div style="max-width:1200px" class="card"><div class="card-header" style="background:#EEEEEE">7/14/2022</div><div class="card-body"><div class="card-title h5"><h2>SVO Ray Tracer Update #5 - Improving Traversal to Remove Artifacts</h2></div><a href="https://github.com/Onlinerocker/SVO">Project&#x27;s GitHub Repo</a><br/><br/><div class="card-title h5">The Old GetNextVoxelFunction</div>The outline of my traversal algorithm was taken from an NVIDIA paper (described in previous updates). This algorithm, however, was in pseudo-code and left many of the specific details as a black box. Specifically, the function that determined the next voxel to move to based on the ray’s exit point was something I wrote myself without guidance. The idea of my implementation was to determine which side of the voxel the ray exited on. This would imply the next voxel the ray was entering. I don’t even consider the direction of the ray, just the normal of the face the ray exits on. This works perfectly fine in all cases EXCEPT corners and edges. The calculated normal on corners and edges actually implies the ray should travel to the diagonal voxel, which isn’t desired. To solve this, I let the algorithm arbitrarily pick which direction to take. This meant that sometimes it would pick a direction that didn’t make sense with direction of a ray. Observe the following case:<br/><img src="../amazing_corner_visual.png" style="width:40%;max-width:600px;padding-right:19px" class=""/><br/><br/>As you can see, (assuming left hand coordinate system) the algorithm may choose -Y instead of +X which doesn’t make sense when you consider the ray’s actual direction. To solve this, I added a check that made sure the face it chose coincided with the ray’s direction.<br/><br/>Despite all my efforts, though, I was still seeing artifacts occasionally. The artifacts rendered when the traversal algorithm determined there was no valid voxel to move and it had not exited the root node. They were infrequent enough to not disturb the final image and making them render as black made them even less discernable. I don’t think anybody ever noticed them. They definitely bugged me though, and it was time to get rid of them!<br/><br/><img src="../traversal_artifacts.PNG" style="width:50%;max-width:900px;padding-right:19px" class=""/><br/><br/><img src="../trav_artifacts1.PNG" style="width:50%;max-width:900px;padding-right:19px" class=""/><br/><i>Traversal artifacts (rendered as red)</i><br/><br/><div class="card-title h5">The New GetNextVoxel Function</div>I was never super happy with my implementation of GetNextVoxel. It was hacky and required calculating a normal whenever you wanted you wanted to get the next voxel. I decided to read up on common voxel traversals to see how they determined the next voxel to move to. The paper A Fast Voxel Traversal Algorithm for Ray Tracing  (Amanatides and Woo) proved the most useful for me. The way they decide which voxel to step to next is actually determined in the ray trace function itself. Recall that we intersect the max and min planes for a given voxel on the X, Y, and Z axis when in the ray trace box function. These minimum of these max plane intersections actually tells us which face of the voxel the ray exits on. This is intuitive if you see an image:<br/><br/><img src="../plane_intersections.png" style="width:30%;max-width:500px;padding-right:19px" class=""/><br/><i>2D demonstration of min/max plane intersections</i><br/><br/>As you can see the ray hits the max X plane before it hits the max Y plane. Thus, we know the ray exits the voxel on one of the X planes. Determining which one is implied by the direction of the ray on that given dimension. Since the ray has a negative X direction, it can be deduced that the ray exits on the positive X face.<br/><br/>After implementing this new GetNextVoxel function the artifacts were reduced slightly, but were still present.<br/><br/><img src="../before_trav_fix.PNG" style="width:50%;max-width:900px;padding-right:19px" class=""/><br/><i>Artifacts after new GetNextVoxel function was implemented</i><br/><br/>On corners/edges, however, two planes were actually tied for the minimum T value. I accounted for this by allowing the traversal to choose the other valid plane if it meant the ray would traverse into a voxel rather than exiting the root. With this change I was now back to the previous number of artifacts! It was evident these artifacts were occurring from something other than my GetNextVoxel function. This was still a win, however, because the new GetVoxelFunction reduced complexity and required less instructions overall.<br/><br/>While exploring the traversal code again I noticed when popping up the stack of root voxels (upon exiting a child root) I wasn’t recalculating the exit plane. This was clearly going to cause issues because the exit plane of a child voxel and root voxel could differ greatly. After a few lines of code to recalculate this, the artifacts were finally gone.<br/><br/><img src="../after_traav_fix.PNG" style="width:50%;max-width:900px;padding-right:19px" class=""/><br/><i>After recalculating the exit plane upon popping up the root voxel stack (no artifacts!)</i><br/><br/></div></div></div><br/></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/svo_update5/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-a561c8ea411b32d07864.js"],"app":["/app-d49afff437e1dfef4477.js"],"component---src-pages-about-js":["/component---src-pages-about-js-f809a0007826d4d47c6f.js"],"component---src-pages-blog-js":["/component---src-pages-blog-js-84c0b4aee1551b5173e0.js"],"component---src-pages-cel-shade-js":["/component---src-pages-cel-shade-js-ca85c40fd0dc961a9afb.js"],"component---src-pages-fiea-js":["/component---src-pages-fiea-js-3e5a85163a24ccbb3430.js"],"component---src-pages-index-js":["/component---src-pages-index-js-444d28301b6c2db48fbd.js"],"component---src-pages-resume-js":["/component---src-pages-resume-js-a7b1c3e262357048863a.js"],"component---src-pages-snow-effect-js":["/component---src-pages-snow-effect-js-3e12d86bd376e5256fa1.js"],"component---src-pages-svo-index-js":["/component---src-pages-svo-index-js-c4a36c4aadef1763f1bc.js"],"component---src-pages-svo-update-1-js":["/component---src-pages-svo-update-1-js-0723e46ca5eabec566ec.js"],"component---src-pages-svo-update-2-js":["/component---src-pages-svo-update-2-js-9974a81af8a7dfb78926.js"],"component---src-pages-svo-update-3-js":["/component---src-pages-svo-update-3-js-611c27f570b6cf21ce40.js"],"component---src-pages-svo-update-4-js":["/component---src-pages-svo-update-4-js-acb33032709bbbe4d10c.js"],"component---src-pages-svo-update-5-js":["/component---src-pages-svo-update-5-js-fcc98e07cae929786ffb.js"],"component---src-pages-svo-update-6-js":["/component---src-pages-svo-update-6-js-6186cec2da3807c317a1.js"],"component---src-pages-svo-update-7-js":["/component---src-pages-svo-update-7-js-d1cfc17bad37dbf9f06e.js"],"component---src-pages-tree-gen-js":["/component---src-pages-tree-gen-js-46604832a1ded72290bc.js"],"component---src-pages-ultrastack-js":["/component---src-pages-ultrastack-js-8d1b2327b1d8c768ad31.js"]};/*]]>*/</script><script src="/polyfill-a561c8ea411b32d07864.js" nomodule=""></script><script src="/component---src-pages-svo-update-5-js-fcc98e07cae929786ffb.js" async=""></script><script src="/commons-a30d9b8c89d158d4c38c.js" async=""></script><script src="/app-d49afff437e1dfef4477.js" async=""></script><script src="/framework-aad5b025b9e173e1e8c7.js" async=""></script><script src="/webpack-runtime-8318ef4a64b565e59cda.js" async=""></script></body></html>